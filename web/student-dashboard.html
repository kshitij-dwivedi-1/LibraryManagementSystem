<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Library Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar h1 {
            font-size: 1.5rem;
        }

        .navbar .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: white;
            color: #667eea;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .stat-card .icon {
            font-size: 3rem;
        }

        .stat-card .info h3 {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .stat-card .info p {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .content-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-bar input,
        .search-bar select {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .search-bar button {
            padding: 10px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .search-bar button:hover {
            background: #5568d3;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .book-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: transform 0.3s;
            cursor: pointer;
        }

        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .book-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .book-card p {
            color: #666;
            margin-bottom: 5px;
        }

        .book-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .availability {
            margin-top: 10px;
            font-weight: 600;
        }

        .available {
            color: #4caf50;
        }

        .unavailable {
            color: #f44336;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>üìö Library Management System</h1>
        <div class="user-info">
            <span id="userFullName">Student User</span>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="icon">üìñ</div>
                <div class="info">
                    <h3>Books Issued</h3>
                    <p id="myIssuedBooks">2</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="icon">üìö</div>
                <div class="info">
                    <h3>Available Limit</h3>
                    <p id="availableLimit">1</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="icon">‚ö†Ô∏è</div>
                <div class="info">
                    <h3>Overdue Books</h3>
                    <p id="myOverdueBooks">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="icon">üí∞</div>
                <div class="info">
                    <h3>Total Fine</h3>
                    <p id="totalFine">Rs 0.00</p>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('browse')">Browse Books</button>
            <button class="tab-btn" onclick="showTab('mybooks')">My Issued Books</button>
            <button class="tab-btn" onclick="showTab('history')">History</button>
        </div>

        <!-- Browse Books Tab -->
        <div id="browse" class="tab-content active">
            <div class="content-card">
                <h2 style="margin-bottom: 20px;">Browse Available Books</h2>
                
                <div class="search-bar">
                    <input type="text" id="searchQuery" placeholder="Search by title or author...">
                    <select id="searchType">
                        <option value="title">By Title</option>
                        <option value="author">By Author</option>
                    </select>
                    <button onclick="searchBooks()">Search</button>
                </div>

                <div class="book-grid" id="bookGrid">
                    <!-- Book cards will be populated here -->
                    <div class="book-card">
                        <h3>Clean Code</h3>
                        <p><strong>Author:</strong> Robert C. Martin</p>
                        <p><strong>ISBN:</strong> 978-0132350884</p>
                        <p><strong>Category:</strong> Programming</p>
                        <p><strong>Publisher:</strong> Prentice Hall</p>
                        <p class="availability available">‚úì Available (3 copies)</p>
                    </div>

                    <div class="book-card">
                        <h3>Effective Java</h3>
                        <p><strong>Author:</strong> Joshua Bloch</p>
                        <p><strong>ISBN:</strong> 978-0134685991</p>
                        <p><strong>Category:</strong> Programming</p>
                        <p><strong>Publisher:</strong> Addison-Wesley</p>
                        <p class="availability available">‚úì Available (2 copies)</p>
                    </div>

                    <div class="book-card">
                        <h3>Design Patterns</h3>
                        <p><strong>Author:</strong> Gang of Four</p>
                        <p><strong>ISBN:</strong> 978-0201633612</p>
                        <p><strong>Category:</strong> Software Engineering</p>
                        <p><strong>Publisher:</strong> Addison-Wesley</p>
                        <p class="availability unavailable">‚úó Not Available</p>
                    </div>

                    <div class="book-card">
                        <h3>Head First Java</h3>
                        <p><strong>Author:</strong> Kathy Sierra</p>
                        <p><strong>ISBN:</strong> 978-0596009205</p>
                        <p><strong>Category:</strong> Programming</p>
                        <p><strong>Publisher:</strong> O'Reilly Media</p>
                        <p class="availability available">‚úì Available (4 copies)</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Issued Books Tab -->
        <div id="mybooks" class="tab-content">
            <div class="content-card">
                <h2 style="margin-bottom: 20px;">My Currently Issued Books</h2>
                
                <div class="alert alert-info">
                    <strong>‚ÑπÔ∏è Note:</strong> Books must be returned within 14 days. Fine: Rs 5 per day after due date.
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Book Title</th>
                            <th>Author</th>
                            <th>Issue Date</th>
                            <th>Due Date</th>
                            <th>Days Left</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="myIssuedBooksTable">
                        <tr>
                            <td>Clean Code</td>
                            <td>Robert C. Martin</td>
                            <td>2024-12-15</td>
                            <td>2024-12-29</td>
                            <td>-2 days</td>
                            <td><span class="badge badge-warning">Overdue</span></td>
                        </tr>
                        <tr>
                            <td>Design Patterns</td>
                            <td>Gang of Four</td>
                            <td>2024-12-20</td>
                            <td>2025-01-03</td>
                            <td>3 days</td>
                            <td><span class="badge badge-success">Active</span></td>
                        </tr>
                    </tbody>
                </table>

                <div class="alert alert-warning" style="margin-top: 20px;">
                    <strong>‚ö†Ô∏è Overdue:</strong> You have 1 overdue book. Please return it as soon as possible to avoid further fines.
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history" class="tab-content">
            <div class="content-card">
                <h2 style="margin-bottom: 20px;">My Book History</h2>
                
                <table>
                    <thead>
                        <tr>
                            <th>Book Title</th>
                            <th>Author</th>
                            <th>Issue Date</th>
                            <th>Return Date</th>
                            <th>Fine</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable">
                        <tr>
                            <td>Clean Code</td>
                            <td>Robert C. Martin</td>
                            <td>2024-12-15</td>
                            <td>-</td>
                            <td>Rs 10.00</td>
                            <td><span class="badge badge-warning">Issued</span></td>
                        </tr>
                        <tr>
                            <td>Design Patterns</td>
                            <td>Gang of Four</td>
                            <td>2024-12-20</td>
                            <td>-</td>
                            <td>Rs 0.00</td>
                            <td><span class="badge badge-success">Issued</span></td>
                        </tr>
                        <tr>
                            <td>Java: The Complete Reference</td>
                            <td>Herbert Schildt</td>
                            <td>2024-11-10</td>
                            <td>2024-11-22</td>
                            <td>Rs 0.00</td>
                            <td><span class="badge badge-success">Returned</span></td>
                        </tr>
                        <tr>
                            <td>Database System Concepts</td>
                            <td>Abraham Silberschatz</td>
                            <td>2024-10-15</td>
                            <td>2024-11-02</td>
                            <td>Rs 15.00</td>
                            <td><span class="badge badge-danger">Returned (Late)</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/LibraryManagement/api';

        // Check authentication
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (!user.userId || user.role !== 'STUDENT') {
            window.location.href = 'login.html';
        }
        document.getElementById('userFullName').textContent = user.fullName;

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'browse') loadAvailableBooks();
            if (tabName === 'mybooks') loadMyIssuedBooks();
            if (tabName === 'history') loadMyHistory();
        }

        // Load available books - REAL API CALL
        async function loadAvailableBooks() {
            try {
                const response = await fetch(`${API_BASE}/books?action=available`);
                const books = await response.json();
                
                const bookGrid = document.getElementById('bookGrid');
                if (books.length === 0) {
                    bookGrid.innerHTML = '<p>No books available</p>';
                    return;
                }

                bookGrid.innerHTML = books.map(book => `
                    <div class="book-card">
                        <h3>${book.title}</h3>
                        <p><strong>Author:</strong> ${book.author}</p>
                        <p><strong>ISBN:</strong> ${book.isbn}</p>
                        <p><strong>Category:</strong> ${book.category || 'N/A'}</p>
                        <p><strong>Publisher:</strong> ${book.publisher || 'N/A'}</p>
                        <p class="availability ${book.availableCopies > 0 ? 'available' : 'unavailable'}">
                            ${book.availableCopies > 0 ? '‚úì Available (' + book.availableCopies + ' copies)' : '‚úó Not Available'}
                        </p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading books:', error);
                document.getElementById('bookGrid').innerHTML = '<p style="color:red">Error loading books</p>';
            }
        }

        // Search books - REAL API CALL
        async function searchBooks() {
            const query = document.getElementById('searchQuery').value;
            const type = document.getElementById('searchType').value;
            
            if (!query.trim()) {
                alert('Please enter a search term');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/books?action=search&type=${type}&query=${encodeURIComponent(query)}`);
                const books = await response.json();
                
                const bookGrid = document.getElementById('bookGrid');
                if (books.length === 0) {
                    bookGrid.innerHTML = '<p>No books found matching your search</p>';
                    return;
                }

                bookGrid.innerHTML = books.map(book => `
                    <div class="book-card">
                        <h3>${book.title}</h3>
                        <p><strong>Author:</strong> ${book.author}</p>
                        <p><strong>ISBN:</strong> ${book.isbn}</p>
                        <p><strong>Category:</strong> ${book.category || 'N/A'}</p>
                        <p class="availability ${book.availableCopies > 0 ? 'available' : 'unavailable'}">
                            ${book.availableCopies > 0 ? '‚úì Available (' + book.availableCopies + ' copies)' : '‚úó Not Available'}
                        </p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error searching books:', error);
                alert('Error searching books');
            }
        }

        // Load my issued books - REAL API CALL
        async function loadMyIssuedBooks() {
            try {
                const response = await fetch(`${API_BASE}/issue?action=mybooks&userId=${user.userId}`);
                const issued = await response.json();
                
                const tbody = document.getElementById('myIssuedBooksTable');
                if (issued.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">You have no issued books currently</td></tr>';
                    document.getElementById('myIssuedBooks').textContent = '0';
                    document.getElementById('availableLimit').textContent = '3';
                    return;
                }

                tbody.innerHTML = issued.map(item => {
                    const daysLeft = Math.ceil((new Date(item.dueDate) - new Date()) / (1000 * 60 * 60 * 24));
                    const isOverdue = daysLeft < 0;
                    
                    return `
                        <tr>
                            <td>${item.bookTitle}</td>
                            <td>${item.bookAuthor}</td>
                            <td>${item.issueDate}</td>
                            <td>${item.dueDate}</td>
                            <td>${daysLeft} days</td>
                            <td><span class="badge ${isOverdue ? 'badge-warning' : 'badge-success'}">
                                ${isOverdue ? 'Overdue' : 'Active'}
                            </span></td>
                        </tr>
                    `;
                }).join('');

                document.getElementById('myIssuedBooks').textContent = issued.length;
                document.getElementById('availableLimit').textContent = Math.max(0, 3 - issued.length);
            } catch (error) {
                console.error('Error loading issued books:', error);
            }
        }

        // Load my history - REAL API CALL
        async function loadMyHistory() {
            try {
                const response = await fetch(`${API_BASE}/issue?action=history&userId=${user.userId}`);
                const history = await response.json();
                
                const tbody = document.getElementById('historyTable');
                if (history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">No history available</td></tr>';
                    return;
                }

                let totalFine = 0;
                tbody.innerHTML = history.map(item => {
                    totalFine += item.fineAmount || 0;
                    return `
                        <tr>
                            <td>${item.bookTitle}</td>
                            <td>${item.bookAuthor}</td>
                            <td>${item.issueDate}</td>
                            <td>${item.returnDate || '-'}</td>
                            <td>Rs ${(item.fineAmount || 0).toFixed(2)}</td>
                            <td><span class="badge ${item.status === 'RETURNED' ? 'badge-success' : 'badge-warning'}">
                                ${item.status}
                            </span></td>
                        </tr>
                    `;
                }).join('');

                document.getElementById('totalFine').textContent = 'Rs ' + totalFine.toFixed(2);
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // Initialize
        loadAvailableBooks();
        loadMyIssuedBooks();
    </script>
</body>
</html>